<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub Organizador do YouTube - Meu Site de Tudo</title>
    <link rel="stylesheet" href="../estilo.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        .youtube-body {
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .card {
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                       box-shadow 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                       opacity 0.3s ease, 
                       border-color 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .card.is-watched {
            opacity: 0.6;
        }
        .card.is-watched:hover {
            opacity: 1;
        }
        .card.is-marked-for-ai {
            border-color: #007AFF;
        }
        .badge {
            display: none;
            position: absolute;
            top: 8px;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            z-index: 10;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .watched-badge {
            left: 8px;
            background: rgba(255, 59, 48, 0.9);
        }
        .ai-badge {
            left: 8px;
            background: rgba(0, 122, 255, 0.9);
        }
        .card.is-watched .watched-badge { display: block; }
        .card.is-marked-for-ai .ai-badge { display: block; }
        .card.is-watched.is-marked-for-ai .watched-badge {
            top: 32px;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .item-actions {
            opacity: 0;
            transition: opacity 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 4px;
            border-radius: 12px;
            z-index: 10;
        }
        .action-btn {
             color: white;
             width: 28px;
             height: 28px;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             transition: background-color 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
             font-size: 12px;
        }
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .card:hover .item-actions {
            opacity: 1;
        }
        .loader, .ai-loader, .import-loader {
            border-top-color: #007AFF;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .category-widget {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .category-widget:hover {
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .category-header {
            padding: 20px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
        }
        .category-content-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .category-widget.open .category-content-wrapper {
            grid-template-rows: 1fr;
        }
        .category-content-wrapper > div {
            overflow: hidden;
        }
        .chevron-icon {
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .category-widget.open .chevron-icon {
            transform: rotate(180deg);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #ffffff;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 24px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateX(-2px);
        }

        .hero-youtube {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Inputs e buttons estilo macOS */
        input[type="text"], input[type="url"], select, textarea {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: #ffffff !important;
            border-radius: 8px !important;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
        }

        input[type="text"]:focus, input[type="url"]:focus, select:focus, textarea:focus {
            outline: none !important;
            border-color: #007AFF !important;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2) !important;
        }

        button {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif !important;
            border-radius: 8px !important;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
            border: none !important;
            font-weight: 500 !important;
        }

        .bg-red-600 {
            background: #FF3B30 !important;
        }
        .bg-red-600:hover {
            background: #D70015 !important;
        }
        .bg-blue-600 {
            background: #007AFF !important;
        }
        .bg-blue-600:hover {
            background: #0056CC !important;
        }
        .bg-green-600 {
            background: #34C759 !important;
        }
        .bg-green-600:hover {
            background: #30B650 !important;
        }
        .bg-purple-600 {
            background: #AF52DE !important;
        }
        .bg-purple-600:hover {
            background: #9542BE !important;
        }
        .bg-gray-600 {
            background: rgba(255, 255, 255, 0.1) !important;
        }
        .bg-gray-600:hover {
            background: rgba(255, 255, 255, 0.15) !important;
        }
        .bg-gray-800 {
            background: rgba(255, 255, 255, 0.05) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* Modal style macOS */
        .modal-backdrop > div {
            background: rgba(28, 28, 30, 0.95) !important;
            backdrop-filter: blur(40px) !important;
            -webkit-backdrop-filter: blur(40px) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
    </style>
</head>
<body class="youtube-body antialiased">
    <header>
        <div class="container">
            <img src="../imagens/logo.png" alt="Logo do Site" class="logo">
            <h1>Meu Site de Tudo</h1>
            <nav>
                <ul>
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="index.html" class="active">Hub do YouTube</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div id="app-container" class="container mx-auto p-4 md:p-8">
        <div class="mb-6">
            <a href="../index.html" class="back-link">
                ‚Üê Voltar para Home
            </a>
        </div>

        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white hero-youtube p-6 rounded-2xl">
                <i class="fab fa-youtube text-red-600"></i> Hub Organizador do YouTube
            </h1>
        </header>

        <div id="loader" class="flex justify-center items-center h-64">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-600 h-32 w-32"></div>
        </div>

        <div id="auth-required" class="hidden text-center py-16">
            <div class="max-w-md mx-auto bg-gray-800 rounded-lg p-8 border border-gray-700">
                <div class="mb-6">
                    <i class="fas fa-lock text-4xl text-gray-400 mb-4"></i>
                    <h2 class="text-2xl font-bold text-white mb-2">Login Necess√°rio</h2>
                    <p class="text-gray-400">Voc√™ precisa estar logado para acessar o Hub do YouTube.</p>
                </div>
                <div class="space-y-3">
                    <a href="../auth/login.html" class="block w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-300">
                        Fazer Login
                    </a>
                    <a href="../index.html" class="block w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md transition duration-300">
                        Voltar para Home
                    </a>
                </div>
            </div>
        </div>

        <main id="main-content" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <div class="form-section p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">üóÇÔ∏è Criar Nova Categoria</h2>
                    <form id="add-category-form">
                        <input type="text" id="category-name" placeholder="Ex: Tutoriais de Programa√ß√£o" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        <button type="submit" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">
                            <i class="fas fa-plus"></i> Adicionar Categoria
                        </button>
                    </form>
                </div>

                <div class="form-section p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">ÔøΩ Adicionar V√≠deo ou Canal</h2>
                    <form id="add-item-form">
                        <select id="category-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-red-500" required>
                            <option value="" disabled selected>Selecione uma categoria...</option>
                        </select>
                        <input type="url" id="item-url" placeholder="Cole a URL do v√≠deo ou canal do YouTube" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">
                           <i class="fas fa-plus"></i> Adicionar Item
                        </button>
                    </form>
                </div>
            </div>

            <div id="categories-container" class="space-y-4">
                <p id="no-categories-message" class="text-center text-gray-400 text-xl hidden">Voc√™ ainda n√£o tem categorias. Crie uma acima para come√ßar!</p>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-white mb-4">Confirmar Exclus√£o</h3>
            <p class="text-gray-300 mb-6">Voc√™ tem certeza que deseja excluir "<span id="item-to-delete-name" class="font-semibold"></span>"? Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-md transition">Cancelar</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md transition">Excluir</button>
            </div>
        </div>
    </div>
    
    <div id="description-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Adicionar/Editar Descri√ß√£o</h3>
                <button id="generate-description-ai" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 flex items-center space-x-2">
                    <span class="ai-button-text">‚ú® Gerar com IA</span>
                    <div class="ai-loader w-4 h-4 rounded-full border-2 border-t-2 border-white hidden"></div>
                </button>
            </div>
            <textarea id="description-textarea" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-3 h-40 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Escreva sua anota√ß√£o aqui ou gere uma com IA..."></textarea>
            <div class="flex justify-end space-x-4 mt-4">
                <button id="cancel-description" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-md transition">Cancelar</button>
                <button id="save-description" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition">Salvar</button>
            </div>
        </div>
    </div>
    
    <footer class="mt-12 text-center text-gray-500">
        <div class="container mx-auto p-4">
            <p>&copy; 2025 Meu Site de Tudo. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script type="module">
        import { 
            onAuthStateChange, 
            saveYouTubeVideo, 
            getYouTubeVideos, 
            updateYouTubeVideo, 
            deleteYouTubeVideo,
            generateWithGemini
        } from '../firebase-config.js';

        // Global state
        let currentUser = null;
        let categories = [];
        let currentEditingItem = null;

        // DOM Elements
        const loader = document.getElementById('loader');
        const mainContent = document.getElementById('main-content');
        const authRequired = document.getElementById('auth-required');
        const addCategoryForm = document.getElementById('add-category-form');
        const categoryNameInput = document.getElementById('category-name');
        const addItemForm = document.getElementById('add-item-form');
        const categorySelect = document.getElementById('category-select');
        const itemUrlInput = document.getElementById('item-url');
        const categoriesContainer = document.getElementById('categories-container');
        const noCategoriesMessage = document.getElementById('no-categories-message');
        
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const itemToDeleteNameSpan = document.getElementById('item-to-delete-name');
        
        const descriptionModal = document.getElementById('description-modal');
        const descriptionTextarea = document.getElementById('description-textarea');
        const cancelDescriptionBtn = document.getElementById('cancel-description');
        const saveDescriptionBtn = document.getElementById('save-description');
        const generateDescriptionAiBtn = document.getElementById('generate-description-ai');
        
        let deleteCallback = null;
        let descriptionSaveCallback = null;
        let currentVideoTitleForAI = '';

        // Auth state observer
        onAuthStateChange(async (user) => {
            if (user) {
                currentUser = user;
                await initApp();
            } else {
                currentUser = null;
                showAuthRequired();
            }
        });

        function showAuthRequired() {
            loader.classList.add('hidden');
            mainContent.classList.add('hidden');
            if (authRequired) {
                authRequired.classList.remove('hidden');
            }
        }

        async function initApp() {
            try {
                await loadData();
                setTimeout(() => {
                    loader.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    if (authRequired) {
                        authRequired.classList.add('hidden');
                    }
                    renderCategories();
                    updateCategoryDropdown();
                }, 1000);
            } catch (error) {
                console.error('Error initializing app:', error);
                showAuthRequired();
            }
        }

        async function loadData() {
            if (!currentUser) return;
            
            try {
                const result = await getYouTubeVideos(currentUser.uid);
                if (result.success) {
                    // Group videos by category
                    const categoriesMap = new Map();
                    
                    result.videos.forEach(video => {
                        const categoryName = video.category || 'Sem Categoria';
                        if (!categoriesMap.has(categoryName)) {
                            categoriesMap.set(categoryName, {
                                id: categoryName.toLowerCase().replace(/\s+/g, '-'),
                                name: categoryName,
                                items: []
                            });
                        }
                        
                        categoriesMap.get(categoryName).items.push({
                            id: video.id,
                            ...video
                        });
                    });
                    
                    categories = Array.from(categoriesMap.values());
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function saveVideoData(videoData) {
            if (!currentUser) return { success: false, error: 'User not authenticated' };
            
            try {
                const result = await saveYouTubeVideo(currentUser.uid, videoData);
                if (result.success) {
                    await loadData();
                    renderCategories();
                    updateCategoryDropdown();
                }
                return result;
            } catch (error) {
                console.error('Error saving video:', error);
                return { success: false, error: error.message };
            }
        }

        async function updateVideoData(videoId, updateData) {
            if (!currentUser) return { success: false, error: 'User not authenticated' };
            
            try {
                const result = await updateYouTubeVideo(currentUser.uid, videoId, updateData);
                if (result.success) {
                    await loadData();
                    renderCategories();
                }
                return result;
            } catch (error) {
                console.error('Error updating video:', error);
                return { success: false, error: error.message };
            }
        }

        async function deleteVideoData(videoId) {
            if (!currentUser) return { success: false, error: 'User not authenticated' };
            
            try {
                const result = await deleteYouTubeVideo(currentUser.uid, videoId);
                if (result.success) {
                    await loadData();
                    renderCategories();
                    updateCategoryDropdown();
                }
                return result;
            } catch (error) {
                console.error('Error deleting video:', error);
                return { success: false, error: error.message };
            }
        }

        // Category management
        addCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryName = categoryNameInput.value.trim();
            if (categoryName && currentUser) {
                // Create a placeholder video to establish the category
                const placeholderVideo = {
                    category: categoryName,
                    title: 'Categoria criada',
                    url: '#',
                    thumbnail: 'https://placehold.co/400x225/1f2937/7f8ea3?text=Nova+Categoria',
                    type: 'placeholder',
                    watched: false,
                    description: '',
                    markedForAI: false,
                    isPlaceholder: true
                };
                
                const result = await saveVideoData(placeholderVideo);
                if (result.success) {
                    categoryNameInput.value = '';
                } else {
                    alert('Erro ao criar categoria: ' + result.error);
                }
            }
        });

        // Item management
        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryId = categorySelect.value;
            const url = itemUrlInput.value.trim();
            
            if (categoryId && url && currentUser) {
                const itemData = parseYouTubeUrl(url);
                if (!itemData) {
                    alert("URL do YouTube inv√°lida.");
                    return;
                }
                
                const category = categories.find(cat => cat.id === categoryId);
                if (category) {
                    const newVideo = {
                        ...itemData,
                        category: category.name,
                        watched: false,
                        description: '',
                        markedForAI: false
                    };
                    
                    const result = await saveVideoData(newVideo);
                    if (result.success) {
                        itemUrlInput.value = '';
                    } else {
                        alert('Erro ao adicionar v√≠deo: ' + result.error);
                    }
                }
            }
        });

        // Render categories
        function renderCategories() {
            const openCategories = new Set();
            document.querySelectorAll('.category-widget.open').forEach(widget => {
                openCategories.add(widget.dataset.id);
            });

            categoriesContainer.innerHTML = '';
            
            if (categories.length === 0) {
                noCategoriesMessage.classList.remove('hidden');
                return;
            }
            
            noCategoriesMessage.classList.add('hidden');
            categories.sort((a, b) => a.name.localeCompare(b.name));
            
            categories.forEach(category => {
                const isOpen = openCategories.has(category.id);
                const nonPlaceholderItems = category.items.filter(item => !item.isPlaceholder);
                const itemCount = nonPlaceholderItems.length;
                
                const categoryElement = document.createElement('div');
                categoryElement.className = `category-widget ${isOpen ? 'open' : ''}`;
                categoryElement.dataset.id = category.id;
                categoryElement.innerHTML = `
                    <div class="category-header">
                        <h3 class="text-2xl font-bold text-white">${category.name} (${itemCount})</h3>
                        <div class="flex items-center space-x-4">
                            <button class="text-gray-400 hover:text-white transition delete-category-btn" data-id="${category.id}" data-name="${category.name}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <i class="fas fa-chevron-down text-xl chevron-icon"></i>
                        </div>
                    </div>
                    <div class="category-content-wrapper">
                        <div id="items-container-${category.id}">
                            ${renderItems(category)}
                        </div>
                    </div>
                `;
                categoriesContainer.appendChild(categoryElement);
            });
            
            addAccordionListeners();
            addDeleteCategoryListeners();
            addItemListeners();
        }

        // Render items for a category
        function renderItems(category) {
            const nonPlaceholderItems = category.items.filter(item => !item.isPlaceholder);
            
            if (nonPlaceholderItems.length === 0) {
                return '<p class="text-gray-500 p-6">Nenhum item adicionado a esta categoria ainda.</p>';
            }

            const itemsHtml = nonPlaceholderItems.map(item => {
                const watchedClass = item.watched ? 'is-watched' : '';
                const aiClass = item.markedForAI ? 'is-marked-for-ai' : '';
                const descriptionIcon = item.description ? 'fa-solid' : 'fa-regular';
                
                return `
                    <div class="card rounded-lg overflow-hidden relative group ${watchedClass} ${aiClass}">
                        <div class="badge ai-badge">IA</div>
                        <div class="badge watched-badge">Visto</div>
                        <a href="${item.url}" target="_blank" rel="noopener noreferrer">
                            <img src="${item.thumbnail}" alt="${item.title}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x225/1f2937/7f8ea3?text=YouTube';">
                            <div class="p-4">
                                <h4 class="font-semibold text-white truncate" title="${item.title}">${item.title}</h4>
                                <p class="text-sm text-gray-400 capitalize">${item.type}</p>
                            </div>
                        </a>
                        <div class="item-actions">
                            <button class="action-btn ai-btn" title="Marcar para IA" data-category="${category.id}" data-item="${item.id}">
                                <i class="fas fa-brain"></i>
                            </button>
                            <button class="action-btn watch-btn" title="Marcar como visto" data-category="${category.id}" data-item="${item.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn description-btn" title="Adicionar descri√ß√£o" data-category="${category.id}" data-item="${item.id}">
                                <i class="fas ${descriptionIcon} fa-note-sticky"></i>
                            </button>
                            <button class="action-btn delete-btn" title="Excluir item" data-category="${category.id}" data-item="${item.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">${itemsHtml}</div>`;
        }

        // Add event listeners
        function addAccordionListeners() {
            document.querySelectorAll('.category-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-category-btn')) return;
                    const widget = header.closest('.category-widget');
                    widget.classList.toggle('open');
                });
            });
        }

        function addDeleteCategoryListeners() {
            document.querySelectorAll('.delete-category-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = e.currentTarget.dataset.id;
                    const name = e.currentTarget.dataset.name;
                    openDeleteModal(`a categoria "${name}" e todos os seus itens`, () => deleteCategory(id));
                });
            });
        }

        function addItemListeners() {
            document.querySelectorAll('.ai-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const categoryId = e.currentTarget.dataset.category;
                    const itemId = e.currentTarget.dataset.item;
                    toggleAIMark(categoryId, itemId);
                });
            });

            document.querySelectorAll('.watch-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const categoryId = e.currentTarget.dataset.category;
                    const itemId = e.currentTarget.dataset.item;
                    toggleWatchedStatus(categoryId, itemId);
                });
            });

            document.querySelectorAll('.description-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const categoryId = e.currentTarget.dataset.category;
                    const itemId = e.currentTarget.dataset.item;
                    const item = findItem(categoryId, itemId);
                    if (item) {
                        openDescriptionModal(item.title, item.description || '', (newDesc) => {
                            saveDescription(categoryId, itemId, newDesc);
                        });
                    }
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const categoryId = e.currentTarget.dataset.category;
                    const itemId = e.currentTarget.dataset.item;
                    const item = findItem(categoryId, itemId);
                    if (item) {
                        openDeleteModal(`o item "${item.title}"`, () => deleteItem(categoryId, itemId));
                    }
                });
            });
        }

        // Helper functions
        function findItem(categoryId, itemId) {
            const category = categories.find(cat => cat.id === categoryId);
            return category ? category.items.find(item => item.id === itemId) : null;
        }

        function updateCategoryDropdown() {
            const selectedValue = categorySelect.value;
            categorySelect.innerHTML = '<option value="" disabled selected>Selecione uma categoria...</option>';
            
            categories.sort((a, b) => a.name.localeCompare(b.name));
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
            
            if (selectedValue) {
                categorySelect.value = selectedValue;
            }
        }

        async function deleteCategory(categoryId) {
            if (!currentUser) return;
            
            const category = categories.find(cat => cat.id === categoryId);
            if (!category) return;
            
            try {
                // Delete all videos in this category
                const deletePromises = category.items.map(item => 
                    deleteYouTubeVideo(currentUser.uid, item.id)
                );
                
                await Promise.all(deletePromises);
                await loadData();
                renderCategories();
                updateCategoryDropdown();
            } catch (error) {
                console.error('Error deleting category:', error);
                alert('Erro ao excluir categoria');
            }
        }

        async function deleteItem(categoryId, itemId) {
            if (!currentUser) return;
            
            try {
                const result = await deleteVideoData(itemId);
                if (!result.success) {
                    alert('Erro ao excluir item: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('Erro ao excluir item');
            }
        }

        async function toggleWatchedStatus(categoryId, itemId) {
            const item = findItem(categoryId, itemId);
            if (item && currentUser) {
                try {
                    const result = await updateVideoData(itemId, { watched: !item.watched });
                    if (!result.success) {
                        console.error('Error updating watched status:', result.error);
                    }
                } catch (error) {
                    console.error('Error toggling watched status:', error);
                }
            }
        }

        async function toggleAIMark(categoryId, itemId) {
            const item = findItem(categoryId, itemId);
            if (item && currentUser) {
                try {
                    const result = await updateVideoData(itemId, { markedForAI: !item.markedForAI });
                    if (!result.success) {
                        console.error('Error updating AI mark:', result.error);
                    }
                } catch (error) {
                    console.error('Error toggling AI mark:', error);
                }
            }
        }

        async function saveDescription(categoryId, itemId, newDescription) {
            const item = findItem(categoryId, itemId);
            if (item && currentUser) {
                try {
                    const result = await updateVideoData(itemId, { description: newDescription });
                    if (!result.success) {
                        console.error('Error saving description:', result.error);
                    }
                } catch (error) {
                    console.error('Error saving description:', error);
                }
            }
        }

        // Parse YouTube URL
        function parseYouTubeUrl(url) {
            const videoRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const videoMatch = url.match(videoRegex);
            
            if (videoMatch) {
                const videoId = videoMatch[1];
                return {
                    type: 'v√≠deo',
                    url: `https://www.youtube.com/watch?v=${videoId}`,
                    title: `V√≠deo: ${videoId}`,
                    thumbnail: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`
                };
            }
            
            const channelRegex = /(?:https?:\/\/)?(?:www\.)?youtube\.com\/(?:channel\/([a-zA-Z0-9_-]+)|c\/([a-zA-Z0-9_-]+)|@([a-zA-Z0-9_-]+))/;
            const channelMatch = url.match(channelRegex);
            
            if (channelMatch) {
                const channelId = channelMatch[1] || channelMatch[2] || channelMatch[3];
                return {
                    type: 'canal',
                    url: url,
                    title: `Canal: ${channelId}`,
                    thumbnail: `https://placehold.co/400x225/1f2937/7f8ea3?text=Canal`
                };
            }
            
            return null;
        }

        // Modal functions
        function openDeleteModal(name, onConfirm) {
            itemToDeleteNameSpan.textContent = name;
            deleteCallback = onConfirm;
            deleteModal.classList.remove('hidden');
        }

        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            deleteCallback = null;
        }

        function openDescriptionModal(videoTitle, currentDescription, onSave) {
            descriptionTextarea.value = currentDescription;
            descriptionSaveCallback = onSave;
            currentVideoTitleForAI = videoTitle;
            descriptionModal.classList.remove('hidden');
        }

        function closeDescriptionModal() {
            descriptionModal.classList.add('hidden');
            descriptionSaveCallback = null;
            currentVideoTitleForAI = '';
        }

        // Event listeners for modals
        confirmDeleteBtn.addEventListener('click', () => {
            if (deleteCallback) deleteCallback();
            closeDeleteModal();
        });

        cancelDeleteBtn.addEventListener('click', closeDeleteModal);

        saveDescriptionBtn.addEventListener('click', () => {
            if (descriptionSaveCallback) descriptionSaveCallback(descriptionTextarea.value);
            closeDescriptionModal();
        });

        cancelDescriptionBtn.addEventListener('click', closeDescriptionModal);

        generateDescriptionAiBtn.addEventListener('click', async () => {
            const button = generateDescriptionAiBtn;
            const buttonText = button.querySelector('.ai-button-text');
            const loader = button.querySelector('.ai-loader');

            button.disabled = true;
            buttonText.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                const prompt = `Gere uma descri√ß√£o curta e √∫til para este v√≠deo do YouTube: "${currentVideoTitleForAI}". A descri√ß√£o deve ser em portugu√™s e ter no m√°ximo 100 caracteres.`;
                const result = await generateWithGemini(prompt);
                
                if (result.success) {
                    descriptionTextarea.value = result.text.trim();
                } else {
                    // Fallback to predefined suggestions
                    const suggestions = [
                        "V√≠deo interessante sobre este t√≥pico. Vale a pena assistir!",
                        "Conte√∫do educativo e bem explicado.",
                        "Tutorial pr√°tico e f√°cil de seguir.",
                        "Informa√ß√µes valiosas apresentadas de forma clara.",
                        "√ìtimo recurso para aprender sobre este assunto."
                    ];
                    const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
                    descriptionTextarea.value = randomSuggestion;
                }
            } catch (error) {
                console.error('Error generating description:', error);
                const suggestions = [
                    "V√≠deo interessante sobre este t√≥pico. Vale a pena assistir!",
                    "Conte√∫do educativo e bem explicado.",
                    "Tutorial pr√°tico e f√°cil de seguir.",
                    "Informa√ß√µes valiosas apresentadas de forma clara.",
                    "√ìtimo recurso para aprender sobre este assunto."
                ];
                const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
                descriptionTextarea.value = randomSuggestion;
            } finally {
                button.disabled = false;
                buttonText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
