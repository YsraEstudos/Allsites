<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Site de Tudo - Home</title>
    <link rel="stylesheet" href="estilo.css">
</head>
<body>
    <header>
        <div class="container">
            <img src="imagens/logo.png" alt="Logo do Site" class="logo">
            <h1>Meu Site de Tudo</h1>
            <nav>
                <ul>
                    <li><a href="index.html" class="active">Home</a></li>
                    <li><a href="youtube/index.html">Hub do YouTube</a></li>
                    <li><a href="estudos/index.html">Rastreador de Estudos</a></li>
                </ul>
            </nav>
            <div class="auth-section" id="authSection">
                <div class="user-info" id="userInfo" style="display: none;">
                    <div class="user-profile">
                        <div class="profile-photo" id="profilePhoto">
                            <img id="profileImage" style="display: none;" alt="Foto do perfil">
                            <div class="profile-initials" id="profileInitials"></div>
                        </div>
                        <div class="user-details">
                            <span class="user-name" id="userName"></span>
                            <span class="user-email" id="userEmail"></span>
                        </div>
                        <div class="user-actions">
                            <button id="profileBtn" class="profile-btn" title="Editar Perfil">‚öôÔ∏è</button>
                            <button id="logoutBtn" class="logout-btn">Sair</button>
                        </div>
                    </div>
                </div>
                <div class="login-prompt" id="loginPrompt">
                    <a href="auth/login.html" class="login-link">Entrar</a>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <section class="hero">
                <h2>Bem-vindo ao Meu Site de Tudo</h2>
                <p>Um espa√ßo minimalista para organizar e descobrir conte√∫dos interessantes.</p>
            </section>

            <section class="sections">
                <h3>Se√ß√µes Dispon√≠veis</h3>
                <div class="section-cards">
                    <div class="card">
                        <h4>üé¨ Hub Organizador do YouTube</h4>
                        <p>Organize, anote e gerencie seus v√≠deos e canais favoritos do YouTube com categorias personalizadas</p>
                        <a href="youtube/index.html" class="btn">Acessar Hub</a>
                    </div>

                    <div class="card">
                        <h4>üìö Rastreador de Estudos</h4>
                        <p>Adicione t√≥picos de estudo e acompanhe seu progresso di√°rio marcando 3 exerc√≠cios por mat√©ria</p>
                        <a href="estudos/index.html" class="btn">Acessar Rastreador</a>
                    </div>

                    <div class="card">
                        <h4>üéØ Desafio 67 Dias</h4>
                        <p>Transforme sua vida em 67 dias com h√°bitos consistentes e acompanhamento di√°rio</p>
                        <a href="https://66dias.netlify.app/" target="_blank" rel="noopener noreferrer" class="btn">Acessar Desafio</a>
                    </div>
                    
                    <!-- Espa√ßo para futuras se√ß√µes -->
                    <div class="card coming-soon">
                        <h4>‚ú® Mais Funcionalidades</h4>
                        <p>Novas ferramentas e recursos ser√£o adicionados em breve.</p>
                        <span class="btn disabled">Em Breve</span>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Meu Site de Tudo. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script type="module">
        import { onAuthStateChange, logoutUser, getUserProfile, updateUserProfile, uploadProfilePhoto, deleteProfilePhoto, getUserInitials } from './meu-site-de-tudo/firebase-config.js';

        const userInfo = document.getElementById('userInfo');
        const loginPrompt = document.getElementById('loginPrompt');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const profilePhoto = document.getElementById('profilePhoto');
        const profileImage = document.getElementById('profileImage');
        const profileInitials = document.getElementById('profileInitials');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileBtn = document.getElementById('profileBtn');

        let currentUser = null;

        // Auth state observer
        onAuthStateChange(async (user) => {
            currentUser = user;
            if (user) {
                // User is signed in
                userEmail.textContent = user.email;
                
                // Load user profile
                await loadUserProfile(user);
                
                userInfo.style.display = 'flex';
                loginPrompt.style.display = 'none';
            } else {
                // User is signed out - redirect to login
                window.location.href = './auth/login.html';
            }
        });

        async function loadUserProfile(user) {
            try {
                const result = await getUserProfile(user.uid);
                let profile = result.success ? result.profile : {};
                
                // Use Firebase Auth data as fallback
                const displayName = profile.displayName || user.displayName || '';
                const photoURL = profile.photoURL || user.photoURL || '';
                
                // Update display name
                userName.textContent = displayName || user.email.split('@')[0];
                
                // Update profile photo
                if (photoURL) {
                    profileImage.src = photoURL;
                    profileImage.style.display = 'block';
                    profileInitials.style.display = 'none';
                } else {
                    profileImage.style.display = 'none';
                    profileInitials.style.display = 'flex';
                    profileInitials.textContent = getUserInitials(displayName, user.email);
                }
                
            } catch (error) {
                console.error('Error loading profile:', error);
                // Use fallback values
                userName.textContent = user.email.split('@')[0];
                profileImage.style.display = 'none';
                profileInitials.style.display = 'flex';
                profileInitials.textContent = getUserInitials('', user.email);
            }
        }

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            try {
                await logoutUser();
                // Auth state observer will handle UI updates
            } catch (error) {
                console.error('Error signing out:', error);
            }
        });

        // Profile modal functionality
        profileBtn.addEventListener('click', () => {
            if (currentUser) {
                showProfileModal();
            }
        });

        function showProfileModal() {
            // Create profile modal if it doesn't exist
            if (!document.getElementById('profileModal')) {
                createProfileModal();
            }
            
            const modal = document.getElementById('profileModal');
            populateProfileModal();
            modal.classList.add('active');
        }

        function createProfileModal() {
            const modalHTML = `
                <div id="profileModal" class="profile-modal">
                    <div class="profile-modal-content">
                        <div class="profile-modal-header">
                            <h3 class="profile-modal-title">Editar Perfil</h3>
                            <button class="profile-modal-close" id="closeProfileModal">√ó</button>
                        </div>
                        
                        <form class="profile-form" id="profileForm">
                            <div class="profile-photo-section">
                                <div class="profile-photo-preview" id="photoPreview">
                                    <img id="previewImage" style="display: none;" alt="Preview">
                                    <div class="profile-initials" id="previewInitials"></div>
                                </div>
                                
                                <div class="photo-upload-section">
                                    <input type="file" id="photoUpload" class="photo-upload-input" accept="image/*">
                                    <button type="button" class="photo-upload-btn" id="uploadBtn">Escolher Foto</button>
                                    <button type="button" class="photo-remove-btn" id="removePhotoBtn" style="display: none;">Remover Foto</button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="profileDisplayName">Nome</label>
                                <input type="text" id="profileDisplayName" placeholder="Seu nome completo">
                            </div>
                            
                            <div class="profile-modal-actions">
                                <button type="button" class="profile-cancel-btn" id="cancelProfileBtn">Cancelar</button>
                                <button type="submit" class="profile-save-btn" id="saveProfileBtn">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add event listeners
            document.getElementById('closeProfileModal').addEventListener('click', hideProfileModal);
            document.getElementById('cancelProfileBtn').addEventListener('click', hideProfileModal);
            document.getElementById('uploadBtn').addEventListener('click', () => {
                document.getElementById('photoUpload').click();
            });
            document.getElementById('photoUpload').addEventListener('change', handlePhotoUpload);
            document.getElementById('removePhotoBtn').addEventListener('click', handlePhotoRemove);
            document.getElementById('profileForm').addEventListener('submit', handleProfileSave);
            
            // Close modal when clicking outside
            document.getElementById('profileModal').addEventListener('click', (e) => {
                if (e.target.id === 'profileModal') {
                    hideProfileModal();
                }
            });
        }

        function populateProfileModal() {
            if (!currentUser) return;
            
            const displayNameInput = document.getElementById('profileDisplayName');
            const previewImage = document.getElementById('previewImage');
            const previewInitials = document.getElementById('previewInitials');
            const removeBtn = document.getElementById('removePhotoBtn');
            
            displayNameInput.value = currentUser.displayName || '';
            
            if (currentUser.photoURL) {
                previewImage.src = currentUser.photoURL;
                previewImage.style.display = 'block';
                previewInitials.style.display = 'none';
                removeBtn.style.display = 'block';
            } else {
                previewImage.style.display = 'none';
                previewInitials.style.display = 'flex';
                previewInitials.textContent = getUserInitials(currentUser.displayName, currentUser.email);
                removeBtn.style.display = 'none';
            }
        }

        function hideProfileModal() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewImage = document.getElementById('previewImage');
                    const previewInitials = document.getElementById('previewInitials');
                    const removeBtn = document.getElementById('removePhotoBtn');
                    
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    previewInitials.style.display = 'none';
                    removeBtn.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function handlePhotoRemove() {
            const previewImage = document.getElementById('previewImage');
            const previewInitials = document.getElementById('previewInitials');
            const removeBtn = document.getElementById('removePhotoBtn');
            const photoUpload = document.getElementById('photoUpload');
            
            previewImage.style.display = 'none';
            previewInitials.style.display = 'flex';
            removeBtn.style.display = 'none';
            photoUpload.value = '';
            
            const displayName = document.getElementById('profileDisplayName').value;
            previewInitials.textContent = getUserInitials(displayName, currentUser.email);
        }

        async function handleProfileSave(e) {
            e.preventDefault();
            
            if (!currentUser) {
                console.error('No current user');
                return;
            }
            
            const saveBtn = document.getElementById('saveProfileBtn');
            const displayName = document.getElementById('profileDisplayName').value.trim();
            const photoUpload = document.getElementById('photoUpload');
            
            console.log('Starting profile save for user:', currentUser.uid);
            console.log('Display name:', displayName);
            console.log('Has photo file:', !!photoUpload.files[0]);
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvando...';
            
            try {
                let photoURL = currentUser.photoURL || '';
                
                // Handle photo upload first
                if (photoUpload.files[0]) {
                    console.log('Uploading new photo...');
                    const uploadResult = await uploadProfilePhoto(currentUser.uid, photoUpload.files[0]);
                    if (uploadResult.success) {
                        photoURL = uploadResult.photoURL;
                        console.log('Photo uploaded successfully:', photoURL);
                    } else {
                        throw new Error('Falha no upload da foto: ' + uploadResult.error);
                    }
                } else if (document.getElementById('previewImage').style.display === 'none' && currentUser.photoURL) {
                    // Photo was removed
                    console.log('Removing photo...');
                    const deleteResult = await deleteProfilePhoto(currentUser.uid, currentUser.photoURL);
                    if (deleteResult.success) {
                        photoURL = '';
                        console.log('Photo removed successfully');
                    } else {
                        console.warn('Failed to delete photo, but continuing:', deleteResult.error);
                        photoURL = '';
                    }
                }
                
                // Update profile with all data
                console.log('Updating profile...');
                const updateData = {
                    displayName: displayName,
                    photoURL: photoURL
                };
                
                const updateResult = await updateUserProfile(currentUser.uid, updateData);
                if (!updateResult.success) {
                    throw new Error('Falha ao atualizar perfil: ' + updateResult.error);
                }
                
                console.log('Profile updated successfully');
                
                // Reload profile in main page
                console.log('Reloading profile display...');
                await loadUserProfile(currentUser);
                
                hideProfileModal();
                console.log('Profile save completed successfully');
                
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Erro ao salvar perfil: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Salvar';
            }
        }
    </script>
</body>
</html>
